download() {
    if [ ! -e ${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION}.tar.gz ]; then
        case "$DISTRO_BINARY_COMPAT" in
        debian)
            LD_LIBRARY_PATH= debootstrap --foreign --variant=minbase --components=main,contrib,non-free --include=sudo,libgtk2.0-0,gtk2-engines-pixbuf,dbus-user-session,libgtk-3-0,xfce4-terminal ${DISTRO_COMPAT_VERSION} ${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION} http://deb.debian.org/debian
            ;;

        ubuntu)
            LD_LIBRARY_PATH= debootstrap --foreign --variant=minbase --components=main,restricted,universe,multiverse --include=sudo,libgtk2.0-0,gtk2-engines-pixbuf,dbus-user-session,libgtk-3-0,xfce4-terminal ${DISTRO_COMPAT_VERSION} ${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION} http://archive.ubuntu.com/ubuntu
            ;;

        *)
            exit 1
            ;;
        esac

        tar -c ${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION} | gzip -9 > ${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION}.tar.gz
        rm -rf ${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION}
    fi
}

build() {
    tar -xzf ${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION}.tar.gz -C /opt
    mv /opt/${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION} /opt/compat-chroot

    chroot /opt/compat-chroot /debootstrap/debootstrap --second-stage

    chroot /opt/compat-chroot addgroup --gid `id -g spot` spot
    yes "" | chroot /opt/compat-chroot adduser --uid `id -u spot` --ingroup spot --disabled-password spot
    chroot /opt/compat-chroot adduser spot sudo

    chmod 700 /opt/compat-chroot/root

    echo "spot	ALL=(ALL:ALL) NOPASSWD: ALL" > /opt/compat-chroot/etc/sudoers.d/spot
    chmod 400 /opt/compat-chroot/etc/sudoers.d/spot

    mkdir -p /etc/xdg/autostart
    cat << EOF > /etc/xdg/autostart/${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION}.desktop
[Desktop Entry]
Version=1.0
Name=${DISTRO_COMPAT_VERSION}
Comment=${NAME} ${VERSION_ID}
Exec=compat-chroot /opt/compat-chroot
Terminal=false
Type=Application
EOF

    $CC $CFLAGS -D_GNU_SOURCE compat-chroot-watch.c $LDFLAGS -o /usr/sbin/compat-chroot-watch

    sed 's~^Icon=.*~Icon=/usr/share/pixmaps/puppy/terminal.svg~' -i /opt/compat-chroot/usr/share/applications/xfce4-terminal.desktop
}