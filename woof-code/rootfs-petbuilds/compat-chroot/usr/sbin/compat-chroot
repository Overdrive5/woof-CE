#!/bin/sh -e

BINDS="/dev /proc /sys /tmp /run /root /home/spot /usr/share/fonts /etc/fonts /usr/share/fontconfig /bin/busybox /bin/ash /usr/sbin/run-as-spot /usr/sbin/setup-spot /etc/hosts /etc/resolv.conf"
THEME_BINDS="/usr/share/themes /usr/share/icons"

cleanup() {
	for DIR in $BINDS; do
		umount -l /$1$DIR 2>/dev/null || :
	done

	for DIR in $THEME_BINDS; do
		umount -l /$1$DIR/* 2>/dev/null || :
	done
}

trap cleanup EXIT INT ERR

for DIR in $BINDS; do
	if [ -d $DIR ]; then
		mkdir -p /$1$DIR
	else
		touch /$1$DIR
	fi
	mount --rbind /$DIR /$1$DIR || :
done

for DIR in $THEME_BINDS; do
	for THEME in /$DIR/*; do
		[ -f $THEME/index.theme ] || continue

		if [ -d $THEME ]; then
			mkdir -p /$1$THEME
		else
			touch /$1$THEME
		fi
		mount --rbind $THEME /$1$THEME || :
	done
done

. $1/etc/os-release
compat-chroot-watch ~/.local/share/applications $1/usr/share/applications $1 "fixmenus; jwm -reload" " ($NAME $VERSION_ID)"